import streamlit as st
import pandas as pd
import logging
from datetime import datetime
from typing import Optional, Dict, List
import uuid
import supabase_config

logger = logging.getLogger(__name__)

# ======================
# Fun√ß√µes de Gerenciamento de Viabilidades (Supabase)
# ======================

def create_viability_request(user_name: str, viability_data: Dict) -> bool:
    """Cria nova solicita√ß√£o de viabiliza√ß√£o no Supabase"""
    try:
        supabase = supabase_config.supabase
        
        new_request = {
            'usuario': user_name,
            'plus_code_cliente': viability_data.get('plus_code', ''),
            'cto_numero': viability_data.get('cto_numero', ''),
            'distancia_real': viability_data.get('distancia_real', ''),
            'distancia_sobra': viability_data.get('distancia_sobra', ''),
            'localizacao_caixa': viability_data.get('localizacao_caixa', ''),
            'portas_disponiveis': None,
            'menor_rx': None,
            'status': 'pendente',
            'motivo_rejeicao': None,
            'data_solicitacao': datetime.now().isoformat(),
            'data_auditoria': None,
            'data_finalizacao': None,
            'auditado_por': None
        }
        
        response = supabase.table('viabilizacoes').insert(new_request).execute()
        logger.info(f"Viabiliza√ß√£o criada: {response.data[0]['id']}")
        return True
        
    except Exception as e:
        logger.error(f"Erro ao criar solicita√ß√£o: {e}")
        st.error(f"Erro ao salvar viabiliza√ß√£o: {e}")
        return False

@st.cache_data(ttl=60)
def load_viability_data() -> pd.DataFrame:
    """Carrega dados de viabiliza√ß√£o do Supabase"""
    try:
        supabase = supabase_config.supabase
        response = supabase.table('viabilizacoes').select('*').order('data_solicitacao', desc=True).execute()
        
        if response.data:
            df = pd.DataFrame(response.data)
            logger.info(f"Carregadas {len(df)} viabiliza√ß√µes")
            return df
        else:
            return pd.DataFrame()
            
    except Exception as e:
        logger.error(f"Erro ao carregar viabiliza√ß√µes: {e}")
        st.error(f"Erro ao carregar dados: {e}")
        return pd.DataFrame()

def update_viability_status(viability_id: str, status: str, **kwargs) -> bool:
    """Atualiza status e dados de uma viabiliza√ß√£o"""
    try:
        supabase = supabase_config.supabase
        
        update_data = {'status': status}
        
        # Adicionar timestamps automaticamente
        if status == 'aprovado':
            update_data['data_auditoria'] = datetime.now().isoformat()
        elif status == 'rejeitado':
            update_data['data_auditoria'] = datetime.now().isoformat()
        elif status == 'finalizado':
            update_data['data_finalizacao'] = datetime.now().isoformat()
        
        # Adicionar outros dados
        update_data.update(kwargs)
        
        response = supabase.table('viabilizacoes').update(
            update_data
        ).eq('id', viability_id).execute()
        
        logger.info(f"Viabiliza√ß√£o atualizada: {viability_id} -> {status}")
        st.cache_data.clear()
        return True
        
    except Exception as e:
        logger.error(f"Erro ao atualizar viabiliza√ß√£o: {e}")
        st.error(f"Erro ao atualizar: {e}")
        return False

# ======================
# Interface: Aba de Auditoria (Leo)
# ======================

def show_audit_tab():
    """Aba de auditoria - acesso restrito ao Leo"""
    st.header("üîç Auditoria de Viabiliza√ß√µes")
    
    if st.session_state.user_name.lower() != "leo":
        st.error("üö´ Acesso restrito! Apenas o usu√°rio 'Leo' pode acessar esta aba.")
        return
    
    df = load_viability_data()
    
    if df.empty:
        st.info("‚úÖ N√£o h√° viabiliza√ß√µes no sistema.")
        return
    
    pending = df[df['status'] == 'pendente'].copy()
    
    if pending.empty:
        st.info("‚úÖ N√£o h√° solicita√ß√µes pendentes de auditoria.")
        return
    
    st.metric("‚è≥ Pendentes", len(pending))
    st.markdown("---")
    
    for idx, row in pending.iterrows():
        # Formatar data para exibi√ß√£o
        data_sol = row['data_solicitacao'][:10] if isinstance(row['data_solicitacao'], str) else row['data_solicitacao'].strftime('%Y-%m-%d')
        
        with st.expander(
            f"üìã Solicita√ß√£o #{row['id'][:8]} - {row['usuario']} - {data_sol}", 
            expanded=True
        ):
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### üìç Informa√ß√µes da Solicita√ß√£o")
                st.text(f"Usu√°rio: {row['usuario']}")
                st.text(f"Plus Code Cliente: {row['plus_code_cliente']}")
                st.text(f"N¬∫ Caixa (CTO): {row['cto_numero']}")
                st.text(f"Dist√¢ncia Real: {row['distancia_real']}")
                st.text(f"Dist√¢ncia c/ Sobra: {row['distancia_sobra']}")
                st.text(f"Localiza√ß√£o Caixa: {row['localizacao_caixa']}")
            
            with col2:
                st.markdown("### ‚úèÔ∏è An√°lise T√©cnica")
                
                portas = st.number_input(
                    "Portas Dispon√≠veis",
                    min_value=0,
                    max_value=50,
                    value=0,
                    key=f"portas_{row['id']}"
                )
                
                menor_rx = st.text_input(
                    "Menor RX (dBm)",
                    placeholder="Ex: -18.67",
                    key=f"rx_{row['id']}"
                )
                
                motivo = st.text_area(
                    "Motivo da Rejei√ß√£o (opcional)",
                    placeholder="Preencher apenas se for rejeitar",
                    key=f"motivo_{row['id']}"
                )
            
            col_btn1, col_btn2 = st.columns(2)
            
            with col_btn1:
                if st.button("‚úÖ Aprovar", key=f"approve_{row['id']}", type="primary", use_container_width=True):
                    if portas > 0 and menor_rx:
                        success = update_viability_status(
                            row['id'],
                            'aprovado',
                            portas_disponiveis=portas,
                            menor_rx=menor_rx,
                            auditado_por='leo'
                        )
                        if success:
                            st.success(f"‚úÖ Solicita√ß√£o #{row['id'][:8]} aprovada!")
                            st.rerun()
                        else:
                            st.error("‚ùå Erro ao aprovar solicita√ß√£o")
                    else:
                        st.warning("‚ö†Ô∏è Preencha todos os campos t√©cnicos para aprovar")
            
            with col_btn2:
                if st.button("‚ùå Rejeitar", key=f"reject_{row['id']}", type="secondary", use_container_width=True):
                    if motivo:
                        success = update_viability_status(
                            row['id'],
                            'rejeitado',
                            motivo_rejeicao=motivo,
                            auditado_por='leo'
                        )
                        if success:
                            st.success(f"‚ùå Solicita√ß√£o #{row['id'][:8]} rejeitada")
                            st.rerun()
                        else:
                            st.error("‚ùå Erro ao rejeitar solicita√ß√£o")
                    else:
                        st.warning("‚ö†Ô∏è Informe o motivo da rejei√ß√£o")
            
            st.markdown("---")

# ======================
# Interface: Aba de Resultados
# ======================

def show_results_tab():
    """Aba de resultados - cada usu√°rio v√™ apenas seus"""
    st.header("üìä Meus Resultados")
    
    df = load_viability_data()
    
    if df.empty:
        st.info("Nenhuma solicita√ß√£o no momento.")
        return
    
    user_results = df[
        (df['usuario'] == st.session_state.user_name) & 
        ((df['status'] == 'aprovado') | (df['status'] == 'rejeitado'))
    ].copy()
    
    if user_results.empty:
        st.info("üî≠ Voc√™ n√£o possui resultados no momento.")
        return
    
    approved = user_results[user_results['status'] == 'aprovado']
    rejected = user_results[user_results['status'] == 'rejeitado']
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric("‚úÖ Aprovadas", len(approved))
    with col2:
        st.metric("‚ùå Rejeitadas", len(rejected))
    
    st.markdown("---")
    
    if not approved.empty:
        st.subheader("‚úÖ Viabiliza√ß√µes Aprovadas")
        for idx, row in approved.iterrows():
            data_aud = row['data_auditoria'][:10] if isinstance(row['data_auditoria'], str) else row['data_auditoria'].strftime('%Y-%m-%d') if row['data_auditoria'] else 'N/A'
            
            with st.expander(f"üì¶ CTO {row['cto_numero']} - {data_aud}", expanded=True):
                
                dados_completos = f"""N¬∫ Caixa: {row['cto_numero']}
Portas dispon√≠veis: {row['portas_disponiveis']}
Menor RX: {row['menor_rx']} dBm
Dist√¢ncia at√© cliente: {row['distancia_sobra']}
Localiza√ß√£o da Caixa: {row['localizacao_caixa']}"""
                
                st.code(dados_completos, language="text")
                
                col_btn1, col_btn2 = st.columns(2)
                
                with col_btn1:
                    st.button("üìã Copiar Dados", key=f"copy_{row['id']}", use_container_width=True)
                    st.caption("üí° Use Ctrl+C para copiar o texto acima")
                
                with col_btn2:
                    if st.button("‚úÖ Finalizar", key=f"finish_{row['id']}", type="primary", use_container_width=True):
                        success = update_viability_status(
                            row['id'],
                            'finalizado'
                        )
                        if success:
                            st.success("‚úÖ Viabiliza√ß√£o finalizada!")
                            st.rerun()
    
    if not rejected.empty:
        st.markdown("---")
        st.subheader("‚ùå Solicita√ß√µes Sem Viabilidade")
        for idx, row in rejected.iterrows():
            data_aud = row['data_auditoria'][:10] if isinstance(row['data_auditoria'], str) else row['data_auditoria'].strftime('%Y-%m-%d') if row['data_auditoria'] else 'N/A'
            
            with st.expander(f"‚ö†Ô∏è {row['plus_code_cliente']} - {data_aud}"):
                st.warning(f"**Motivo:** {row['motivo_rejeicao']}")
                st.text(f"CTO Tentada: {row['cto_numero']}")
                st.text(f"Auditado em: {data_aud}")

# ======================
# Interface: Aba de Relat√≥rios
# ======================

def show_reports_tab():
    """Aba de relat√≥rios/arquivo"""
    st.header("üìà Relat√≥rios e Arquivo")
    
    df = load_viability_data()
    
    if df.empty:
        st.info("Nenhum dado dispon√≠vel.")
        return
    
    finalizadas = df[df['status'] == 'finalizado']
    rejeitadas = df[df['status'] == 'rejeitado']
    pendentes = df[df['status'] == 'pendente']
    
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("‚úÖ Aprovadas", len(finalizadas))
    with col2:
        st.metric("‚ùå Rejeitadas", len(rejeitadas))
    with col3:
        st.metric("‚è≥ Pendentes", len(pendentes))
    with col4:
        total = len(finalizadas) + len(rejeitadas)
        taxa = (len(finalizadas) / total * 100) if total > 0 else 0
        st.metric("üìä Taxa Aprova√ß√£o", f"{taxa:.1f}%")
    
    st.markdown("---")
    
    tab1, tab2 = st.tabs(["‚úÖ Viabilidades Aprovadas", "‚ùå Sem Viabilidade"])
    
    with tab1:
        st.subheader("üìã Viabiliza√ß√µes Finalizadas")
        
        if finalizadas.empty:
            st.info("Nenhuma viabiliza√ß√£o finalizada ainda.")
        else:
            search_approved = st.text_input(
                "üîç Buscar", 
                placeholder="Plus Code, CTO, Usu√°rio...", 
                key="search_approved"
            )
            
            df_display = finalizadas.copy()
            if search_approved:
                mask = df_display.astype(str).apply(
                    lambda x: x.str.lower().str.contains(search_approved.lower(), na=False)
                ).any(axis=1)
                df_display = df_display[mask]
            
            for idx, row in df_display.iterrows():
                data_fin = row['data_finalizacao'][:10] if isinstance(row['data_finalizacao'], str) else row['data_finalizacao'].strftime('%Y-%m-%d') if row['data_finalizacao'] else 'N/A'
                
                with st.expander(f"üì¶ {row['cto_numero']} - {row['usuario']} - {data_fin}"):
                    col1, col2 = st.columns(2)
                    with col1:
                        st.text(f"Usu√°rio: {row['usuario']}")
                        st.text(f"Plus Code: {row['plus_code_cliente']}")
                        st.text(f"N¬∫ Caixa: {row['cto_numero']}")
                        st.text(f"Localiza√ß√£o: {row['localizacao_caixa']}")
                    with col2:
                        st.text(f"Portas: {row['portas_disponiveis']}")
                        st.text(f"Menor RX: {row['menor_rx']} dBm")
                        st.text(f"Dist√¢ncia: {row['distancia_sobra']}")
                        st.text(f"Finalizado: {data_fin}")
    
    with tab2:
        st.subheader("üö´ Solicita√ß√µes Rejeitadas")
        
        if rejeitadas.empty:
            st.info("Nenhuma solicita√ß√£o rejeitada.")
        else:
            search_rejected = st.text_input(
                "üîç Buscar", 
                placeholder="Plus Code, Usu√°rio...", 
                key="search_rejected"
            )
            
            df_display = rejeitadas.copy()
            if search_rejected:
                mask = df_display.astype(str).apply(
                    lambda x: x.str.lower().str.contains(search_rejected.lower(), na=False)
                ).any(axis=1)
                df_display = df_display[mask]
            
            for idx, row in df_display.iterrows():
                data_aud = row['data_auditoria'][:10] if isinstance(row['data_auditoria'], str) else row['data_auditoria'].strftime('%Y-%m-%d') if row['data_auditoria'] else 'N/A'
                
                with st.expander(f"‚ùå {row['plus_code_cliente']} - {row['usuario']} - {data_aud}"):
                    col1, col2 = st.columns(2)
                    with col1:
                        st.text(f"Usu√°rio: {row['usuario']}")
                        st.text(f"Plus Code: {row['plus_code_cliente']}")
                        st.text(f"CTO Tentada: {row['cto_numero']}")
                    with col2:
                        st.warning(f"**Motivo:** {row['motivo_rejeicao']}")
                        st.text(f"Rejeitado em: {data_aud}")
                        st.text(f"Auditado por: {row['auditado_por']}")

# ======================
# Fun√ß√£o Principal
# ======================

def show_viability_system():
    """
    Fun√ß√£o principal que adiciona o sistema de abas ao validador.
    """
    
    st.markdown("---")
    st.markdown("---")
    
    if st.session_state.user_name.lower() == "leo":
        tabs = st.tabs(["üîç Auditoria", "üìä Meus Resultados", "üìà Relat√≥rios"])
        
        with tabs[0]:
            show_audit_tab()
        with tabs[1]:
            show_results_tab()
        with tabs[2]:
            show_reports_tab()
    else:
        tabs = st.tabs(["üìä Meus Resultados", "üìà Relat√≥rios"])
        
        with tabs[0]:
            show_results_tab()
        with tabs[1]:
            show_reports_tab()
